# Intel虚拟化技术 #

## 1. Intel虚拟化技术分类 ##

第一类是处理器相关的，称为VT-x，是实现处理器虚拟化的硬件扩展，这也是硬件虚拟化的基础；
VT-x/VT-i：主要在处理器中实现，允许虚拟机直接执行某些指令，减少VMM负担，以获得更稳定、快速的虚拟机。VT-x指至强处理器的VT技术，VT-i指安腾处理器的VT技术。支持VT的CPU列表

第二类是芯片组相关的，称为VT-d，是从芯片组的层面为虚拟化提供必要支持，通过它，可以实现诸如直接分配物理设备给客户机的功能；
VT-d：VT for Direct I/O，主要在芯片组中实现，允许虚拟机直接访问I/O设备，以减少VMM和CPU的负担。

第三类是输入输出设备相关的，主要目的是通过定义新的输入输出协议，使新一代的输入输出设备可以更好地支持虚拟化环境下的工作，比如Intel网卡自有的VMDq技术和PCI组织定义的单根设备虚拟化协议（SR-IOV）.
VT-c：VT for Connectivity，主要在网卡上实现，包括两个核心技术：VMDq和VMDc。
VMDq：通过网卡上的特定硬件将不同虚拟机的数据包预先分类，然后通过VMM分发给各虚拟机，以此减少由VMM进行数据包分类的CPU开销
VMDc：允许虚拟机直接访问网卡设备。Single Root I/O Virtualization（SR-IOV）是PCI-SIG规范，可以将一个PCIe设备分配给多个虚拟机来直接访问。目前82599万兆控制器和82576千兆控制器支持SR-IOV


## 2. 简介 ##

### 2.1 Xen 与 KVM 比较 ###

Xen是Linux下的一个虚拟化解决方案，但由于被Citrix收购后，变成了和红帽企业版一样了，卖服务收取费用，Redhat从rhel6.0开始已经从内核中把XEN踢出去了，全心投入开发免费的KVM，虽然市场上老用户还在用Xen,但相信kvm会逐步占领大面积的市场，必竟有redhat做为强大支持源。

Xen的实现方法是运行支持Xen功能的kernel，这个kernel是工作在Xen的控制之下，叫做Domain0，使用这个kernel启动机器后，你可以在这个机器上使用qemu软件，虚拟出多个系统。Xen的缺点是如果你需要更新Xen的版本，你需要重新编译整个内核，而且，稍有设置不慎，系统就无法启动。

相比较，KVM就简化的多了。它不需要重新编译内核，也不需要对当前kernel做任何修改，它只是几个可以动态加载的.ko模块。它结构更加精简、代码量更小。所以，出错的可能性更小。并且在某些方面，性能比Xen更胜一筹。

## 2.2 Openstack, kvm及qemu以及libvirt之间的关系 ##
KVM是最底层的hypervisor，它是用来模拟CPU的运行，它缺少了对network和周边I/O的支持，所以我们是没法直接用它的。QEMU就是一个完整的模拟器，它是基于KVM上面的，它提供了完整的网络和I/O支持. Openstack不会直接控制qemu-kvm，它会用一个叫libvit的库去间接控制qemu， libvirt提供了 跨VM平台的功能，它可以控制除了QEMU的模拟器，包括vmware, virtualbox xen等等。所以为了openstack的跨VM性，所以openstack(Nova/Cinder/Glance)只会用libvirt而不直接用qemu。libvirt还提供了一些高级的功能，例如pool/vol管理。

准确来说，KVM是Linux kernel的一个模块。可以用命令modprobe去加载KVM模块。加载了模块后，才能进一步通过其他工具创建虚拟机。但仅有KVM模块是 远远不够的，因为用户无法直接控制内核模块去作事情,你还必须有一个运行在用户空间的工具才行。这个用户空间的工具，kvm开发者选择了已经成型的开源虚拟化软件 QEMU。说起来QEMU也是一个虚拟化软件。它的特点是可虚拟不同的CPU。比如说在x86的CPU上可虚拟一个Power的CPU，并可利用它编译出可运行在Power上的程序。KVM使用了QEMU的一部分，并稍加改造，就成了可控制KVM的用户空间工具了。所以你会看到，官方提供的KVM下载有两大部分(qemu和kvm)三个文件(KVM模块、QEMU工具以及二者的合集)。也就是说，你可以只升级KVM模块，也可以只升级QEMU工具。这就是KVM和QEMU 的关系。

## 3. 大公司支持 ##
IBM不仅有着44年丰富的虚拟化经验，在投资开源虚拟化方面也眼光独到。开源KVM能够提供最佳可扩展性与高性能高安全，同时也是最具性价比的开源虚拟化解决方案。2007年，IBM将KVM作为最佳虚拟化开放技术，投入了巨资。此后，IBM不仅联合红帽等厂商成立OVA，帮助构建KVM生态系统，扩展开源虚拟化市场，而且IBM还有60多位程序员专门工作于KVM开源社区。

### 3.1 IBM对KVM的投资与开发 ###

IBM对KVM开发的关键领域主要包括以下几个方面：

一、核心KVM开发。这包括支持内存过量分配的内存管理，充分利用QEMU虚拟机环境子系统的内存。

二、性能与可扩展性。进行SPECvirt基准测试，围绕着云的优化与性能提升。

三、系统管理。包括对libvirt-CIM管理界面，开发libvirt存储系统。

四、安全与可靠性。包括公共标准认证，涉及目前最新的EAL4+。

五、网络与I/O。Single Root I/O Virtualization(SR-IOV)支持，提升物理PCI设备的虚拟化效能。

六、云优化。支持高密度虚拟化，将虚拟机从VMware与EC2迁移到KVM。

七、数据中心网络。包括网络配置自动化，额外安全支持等。

由此看出，IBM主要从三大领域对KVM进行投资，即性能与可扩展性、安全与可靠性以及云优化，让KVM业务为企业业务就绪。

### 3.2 IBM的KVM解决方案 ###

IBM的KVM方案与红帽有着千丝万缕的联系。

首先，IBM x架构突破了在x86架构上进行虚拟的一些限制。随着虚拟化的发展，x86硬件要足够敏捷才能让客户享受到虚拟化的所有益处。

IBM eX5的MAX5内存扩展能让客户部署红帽企业虚拟化，在单台服务器上运行多个虚拟机，达到高比率整合。MAX5也能扩展内存，达到非eX5服务器内存容量的五倍。在传统10G系统，I/O容量也有四倍提升。

IBM首次将RHEV结合x86模型带入行业，交付优化的服务器性能、领先的可扩展性、显著的I/O提升，帮助用户实现高级的资产利用率和工作负载管理。随着红帽RHEV 3.0的发布，这种一体化的解决方案立即可用。

安全是企业用户采用开源虚拟化技术的重要考量因素。结合红帽企业Linux和IBM System x，使得KVM的安全级别达到了EAL4+。红帽企业Linux拥有安全增强功能SELinux，它是与美国国家安全局(NSA)共同开发的项目。当该功能集成于KVM hypervisor后，云供应商能在一台机器上安全地宿主多租户，通过NSA的Mandatory Access Control(强制访问控制)技术实现虚拟子机的隔离。

带有KVM hypervisor的红帽企业Linux 5.6与6.2版本，正在进行通用标准认证EAL4+级别安全的认证，达到了高安全。RHEL 5.6与IBM System x的组合也成为首个实现EAL4+安全级别的认证开源虚拟化解决方案。这样的解决方案能应用于政府、金融及其他对安全要求高的行业中。

### 3.3 KVM 和 Xen 的比较 ###
#### 3.3.1 宏观考虑 ####
**生态链层面**
KVM到2014年Redhat都不支持了。 Xen 只有Suse和Oracle支持

**架构层面**
Xen主要是负责半虚，KVM主要是负责全虚，需要CPU支持VT。主流的虚拟化都还是聚焦在全虚上面。Xen是混合模式，Kvm是宿主机模式。从架构上讲，xen是自定制的hypervisor，对硬件的资源管理和调度，对虚拟机的生命周期管理等，都是从头开始写的。  KVM全称是Kernel-based Virtual Machine, kernel代表的是Linux kernel。KVM是一个特殊的模块，Linux kernel加载此模块后，可以将Linux kernel 变成hypervisor，因为Linux kernel已经可以很好的实现对硬件资源的调度和管理，KVM只是实现了对虚拟机生命周期管理的相关工作。 KVM的初始版本只有4万行代码，相对于xen的几百万行代码显得非常简洁。

**安全**
Xen需要考虑三方面的安全，一是Hypervisor，二是Dom0，三是DomU。 Kvm主要考虑宿主机和虚拟机的安全

**历史**
许多人都是自己构建内核，Xen可以运行在很多服务器上，从低成本的虚拟专用服务器（Virtual Private Server，VPS）供应商，如Linode，到大型公司，如Amazon的EC2，这些公司都加大了这方面的投入，不会轻易转换到其它技术，即使技术上KVM超越了Xen，也不能一下就取代现有的解决方案，更何况KVM在技术上的优势并不明显，有些地方甚至还未超越Xen，因为Xen的历史比KVM更悠久，它也比KVM更成熟，你会发现Xen中的某些功能在KVM还未实现，因此我们看到KVM项目的Todo List很长，KVM的优势也仅限于它进入了Linux内核。从RHEL 5.4开始，RedHat就支持KVM了，从RHEL 6.0开始RedHat就完全抛弃Xen了。

#### 3.3.2 微观层面 ####
**CPU调度**
需要VT的支持，所以KVM无法历旧，这一块有很大市场，CPU调度层面来考虑，明显没有CFS调度算法简单和高效。当有一个vcpu处理IO时，还可以切换给其它VCPU上面。

**IO虚拟化**
这一块本来是XEN做的最好的，因为XEN是做半虚出家的，所以他的前后端做的非常好，但是现在KVM也有VIRTIO，正在迎头赶上。


#### 3.3.3 虚拟化外围 ####
**虚拟机管理**
虚拟机的管理和迁移，RHEV应该会把她做好。

**虚拟化评测**
性能评测。Specvirt专为KVM开发，使得KVM会更加完善。

**使用方便**
Xen的缺点是如果你需要更新Xen的版本，你需要重新编译整个内核，而且，稍有设置不慎，系统就无法启动。KVM不需要重新编译内核，也不需要对当前kernel做任何修改，它只是几个可以动态加载的.ko模块。它结构更加精简、代码量更小。所以，出错的可能性更小。

# 4. 桌面虚拟化 #

http://www.spice-space.org/home.html

SPICE是去年Red Hat收购Qumranet后获得虚拟技术，被Qumranet使用在其商业虚拟桌面产品SolidIce中。SPICE能用于在服务器和远程计算机如桌面和瘦客户端设备上部署虚拟桌面。它类似于其它用于远程桌面管理的渲染协议，如微软的Remote Desktop Protocol或Citrix的Independent Computing Architecture。
　　
它支持Windows XP、Windows 7和Red Hat Enterprise Linux等虚拟机实例。大部分SPICE代码是采用GNU GPLv2许可证发布，部分代码是采用LGPL许可证。
        
红帽是当今世界上最强大的Linux公司，当然仅限于服务器领域，与此形成鲜明反差的是，它在桌面系统领域几乎可以说是无所作为。现在，这一状况将于2012年得到改观，因为红帽宣布将重新引进一套建立在被称为“独立计算环境初级协议(Simple Protocol for Independent Computing Environments，简称SPICE)之上的虚拟桌面基础架构(简称VDI)。

## 4.1 桌面系统将采用SPICE ##

上述消息并不是说红帽已经完全将有关Linux桌面版系统的相关事宜部署完毕。红帽企业级Linux桌面版目前仍然可用，并且在红帽的庞大商业计划中，桌面系统只是极小的一个组成部分。但这一切现状都可能会改变，很明显红帽如今愿意深入探讨一套针对小型客户的基于服务器的VDI桌面系统。

这一修订版的桌面系统采用SPICE机制，正如微软的远程桌面协议(简称RDP)及Citrix的独立计算架构(ICA)那样，这是一套桌面显示服务协议。这类方案的重点是相同的，即将繁重的运算任务交给服务器完成，而为使用者提供一款小巧低耗的客户机，如此一来，用户会发现自己小巧的客户机在处理问题方面同过往那些庞大的系统一样高效。

这款桌面系统并不会把传统意义上的操作系统，例如即将发布的Ubuntu 11.04或已经发布的Windows 7，当作竞争对手。简化版客户机系统的价值只体现在企业级的运行平台上，例如那些红帽已经在为之提供技术支持的公司。请记住，在Linux服务器(而非桌面系统)方面，红帽已经建立了坚实有力的客户基础。

## 4.2 虚拟化平台的重心——KVM ##

在服务器端，SPICE依靠内核虚拟机(简称KVM)来为大量的任务需求提供强劲的运算能力。猜猜近期红帽将把虚拟化平台的重心放在哪里?无疑正是KVM。因此，如果大家开办了一家公司，而其服务器业务正是由红帽负责的，那么顺水推舟地让他们再提供一套Linux桌面系统互补方案不正是相当有建设性的想法吗?而在这一计划的实施中，没准我们还可以卖掉一些多余的服务器许可来节省开支。这对我个人来说，绝对是非常划算的商务改造计划，而它也能够很好地立足于红帽现有的业务并继续拓展开去。

红帽早先就已经探讨过基于SPICE体系的VDI相关方案，但由于他们发现SPICE这一体系中充斥着不计其数的专有代码，这一计划就暂时搁浅了。正因为红帽公司的服务以开源为前提，因此SPICE这类体系的引入可能会令其服务器处理速度大大下降。

红帽企业虚拟化管理器

正如一位红帽公司的软件工程师在旧金山的Linux基金会协作峰会(Linux Foundation Collaboration Summit)上就红帽SPICE体系向我说明的那样：红帽企业虚拟化管理器 (简称RHVM)，是为以Windows为运行平台的服务器设计的。

没错，就是这么回事。一款以Linux为主体的程序要在Windows环境下才能工作。这，正是我们所能推测到的，红帽至今仍未正式推出不管是基于RHVM还是SPICE的任何桌面系统的原因。正如这位红帽公司的员工所说，“客户大概会向我们问起运行环境方面的情况，而如果我们照实回答‘它得运行在Windows平台的服务器上’，客户们绝对会惊呼‘开玩笑的吧?’”可是，这就是实际情况。

事实上这种改变真的正在悄然发生，尽管速度缓慢。首先，红帽必须从RHVM中“消除那些在Windows系统上可能产生的错误”，而这些可能存在冲突的组件正是在研发时红帽员工添加进去的。这款管理器的下一个版本RHVM 3.0，将于今年年末或明年早些时候推出，会是一款由纯Linux驱动的服务器应用程序。其动态服务器页面(Active Server Page，简称ASP)的相关组件将被替换为Java等可提供相同功能的工具。

将提高SPICE的处理速度

此外，他还谈到红帽正在致力于将SPICE的处理速度提高到其前代产品的水平。“开源SPICE目前能够达到其专用版本处理速度的百分之八十，而我们的目标是让其速度百分之百等同于Fedora 15。”Fedora 15现定于今年五月二十四日发布。对于红帽企业级Linux(简称RHEL)的用户来说，大家可以期待在RHEL 6.2上看到全速运转的SPICE。

将这些信息整理起来不难发现，我们预计可以在2012年初看到一个比较完整的红帽Linux VDI桌面系统。它能够立即取代庞大的传统客户机系统吗?恐怕不行，连红帽公司自身都不指望能做到这一点。但是，正如其提到的，对于商用桌面系统来说“这是针对战术性问题所推出的一种战术性对策”。

就我个人而言，对这款产品还是相当期待的。尽管我自己未必会使用这类简化版的客户机桌面系统，但它对于那些有相关业务需要的工作人员来说还是很有意义的。可以预见，那些已经采用RHEL来管理其服务器的企业将把这款产品当成一种非常自然、能够节约成本、极具拓展性的Linux解决方案，并通过它为行业内部的桌面系统使用者们带来福音。

来源： <http://os.51cto.com/art/201104/255032.htm>
